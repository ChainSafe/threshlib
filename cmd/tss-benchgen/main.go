package main

import (
	"crypto/ecdsa"
	"encoding/hex"
	"encoding/json"
	"flag"
	"fmt"
	"math"
	"os"
	"runtime"
	"sync/atomic"
	"time"

	"github.com/binance-chain/tss-lib/common"
	"github.com/binance-chain/tss-lib/ecdsa/keygen"
	"github.com/binance-chain/tss-lib/test"
	"github.com/binance-chain/tss-lib/tss"
	"github.com/ipfs/go-log"
	"github.com/pkg/errors"
	"golang.org/x/text/language"
	"golang.org/x/text/message"
)

const libLogLevel = "error"

var (
	expectedIncomingMsgs,
	receivedIncomingMsgs,
	nMinus1 float64
	preParamTestData keygen.LocalPreParams
)

func init() {
	preDataJSON, _ := hex.DecodeString(preParamDataHex)
	if err := json.Unmarshal(preDataJSON, &preParamTestData); err != nil {
		panic(err)
	}
}

func usage() {
	if _, err := fmt.Fprintf(os.Stderr, "usage: tss-benchgen [-flag=value, ...] datadir\n"); err != nil {
		panic(err)
	}
	flag.PrintDefaults()
	os.Exit(2)
}

func main() {
	prt := message.NewPrinter(language.English)
	var (
		quorum  = flag.Int("q", 3, "the signing quorum (t+1)")
		parties = flag.Int("n", 8, "the number of party shares to generate (n)")
		procs   = flag.Int("procs", runtime.NumCPU(), "the number of max go procs (threads) to use")
	)
	flag.Usage = usage
	if flag.Parse(); !flag.Parsed() {
		usage()
		os.Exit(1)
	}
	if *parties <= 0 || *quorum <= 1 || *parties < *quorum {
		fmt.Println("Error: n must be greater than 0, q must be greater than 1, q cannot be less than n.")
		os.Exit(1)
	}
	if flag.NArg() < 1 {
		usage()
		os.Exit(1)
	}
	dir := flag.Args()[0]
	if _, err := os.Stat(dir); !os.IsNotExist(err) {
		fmt.Printf("Error: `%s` already exists, delete it first and this tool will create it.\n", dir)
		os.Exit(1)
	}
	if err := os.Mkdir(dir, os.ModePerm); err != nil {
		panic(err)
	}

	fmt.Println("ECDSA/GG20 Benchmark Tool - KeyGen")
	fmt.Println("----------------------------------")
	fmt.Printf("Max go procs (threads): %d\n", *procs)
	fmt.Printf("Generating %d shares, quorum=%d...\n", *parties, *quorum)
	fmt.Println("No network latency.")
	fmt.Println("----------------------------------")

	runtime.GOMAXPROCS(*procs)
	start := time.Now()
	runKeyGen(dir, (*quorum)-1, *parties)
	elapsed := time.Since(start)

	fmt.Printf("Done. %d shares written to `%s`.\n", *parties, dir)
	_, _ = prt.Printf("Finished in %d ms.\n", elapsed.Milliseconds())
	os.Exit(0)
}

func setUp(level string) {
	if err := log.SetLogLevel("tss-lib", level); err != nil {
		panic(err)
	}
}

func setUpProgress(n int) {
	nMinus1 = float64(n) - 1
	expectedIncomingMsgs = (3 * nMinus1) + nMinus1
	receivedIncomingMsgs = -1
}

func incrementAndDisplayProgress() {
	var progress float64
	receivedIncomingMsgs++
	if receivedIncomingMsgs > 0 {
		progress = math.Min(1, receivedIncomingMsgs/expectedIncomingMsgs)
	} else {
		progress = 0
	}
	fmt.Printf("\rProgress: %d%%... ", int(progress*100))
}

func runKeyGen(dir string, t, n int) {
	setUp(libLogLevel)
	setUpProgress(n)

	fmt.Printf("Starting... ")

	pIDs := tss.GenerateTestPartyIDs(n)

	p2pCtx := tss.NewPeerContext(pIDs)
	parties := make([]*keygen.LocalParty, 0, len(pIDs))

	errCh := make(chan *tss.Error, len(pIDs))
	outCh := make(chan tss.Message, len(pIDs))
	endCh := make(chan keygen.LocalPartySaveData, len(pIDs))

	updater := test.SharedPartyUpdater

	// init the parties
	for i := 0; i < len(pIDs); i++ {
		params := tss.NewParameters(p2pCtx, pIDs[i], len(pIDs), t)
		params.UNSAFE_setKGIgnoreH1H2Dupes(true)
		P := keygen.NewLocalParty(params, outCh, endCh, preParamTestData).(*keygen.LocalParty)
		parties = append(parties, P)
		go func(P *keygen.LocalParty) {
			if err := P.Start(); err != nil {
				errCh <- err
			}
		}(P)
	}

	// PHASE: keygen
	var ended int32
outer:
	for {
		select {
		case err := <-errCh:
			common.Logger.Errorf("Error: %s", err)
			panic(err)

		case msg := <-outCh:
			dest := msg.GetTo()
			if dest == nil { // broadcast!
				for _, P := range parties {
					if P.PartyID().Index == msg.GetFrom().Index {
						continue
					}
					go updater(P, msg, errCh)
				}
			} else { // point-to-point!
				if dest[0].Index == msg.GetFrom().Index {
					panic(fmt.Errorf("party %d tried to send a message to itself (%d)", dest[0].Index, msg.GetFrom().Index))
				}
				go updater(parties[dest[0].Index], msg, errCh)
			}
			incrementAndDisplayProgress()

		case save := <-endCh:
			// SAVE a test fixture file for this P (if it doesn't already exist)
			// .. here comes a workaround to recover this party's index (it was removed from save data)
			index, err := save.OriginalIndex()
			if err != nil {
				panic(err)
			}
			tryWriteKeyGenDataFile(dir, index, save)

			atomic.AddInt32(&ended, 1)
			if atomic.LoadInt32(&ended) == int32(len(pIDs)) {
				// build ecdsa key pair
				pkX, pkY := save.ECDSAPub.X(), save.ECDSAPub.Y()
				pk := ecdsa.PublicKey{
					Curve: tss.EC(),
					X:     pkX,
					Y:     pkY,
				}
				sk := ecdsa.PrivateKey{
					PublicKey: pk,
				}
				// test pub key, should be on curve and match pkX, pkY
				if !sk.IsOnCurve(pkX, pkY) {
					panic("public key must be on curve, but it was not")
				}
				break outer
			}
		}
	}
}

func tryWriteKeyGenDataFile(dir string, index int, data keygen.LocalPartySaveData) {
	fixtureFileName := makeKeyGenDataFilePath(dir, index)

	// fixture file does not already exist?
	// if it does, we won't re-create it here
	fi, err := os.Stat(fixtureFileName)
	if !(err == nil && fi != nil && !fi.IsDir()) {
		fd, err := os.OpenFile(fixtureFileName, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, 0o600)
		if err != nil {
			panic(errors.Wrapf(err, "unable to open fixture file %s for writing", fixtureFileName))
		}
		bz, err := json.Marshal(&data)
		if err != nil {
			panic(errors.Wrapf(err, "unable to marshal save data for fixture file %s", fixtureFileName))
		}
		_, err = fd.Write(bz)
		if err != nil {
			panic(errors.Wrapf(err, "unable to write to fixture file %s", fixtureFileName))
		}
		common.Logger.Debugf("Saved a test fixture file for party %d: %s\n", index, fixtureFileName)
	} else {
		fmt.Printf("\nFixture file already exists for party %d; not re-creating: %s\n", index, fixtureFileName)
	}
	//
}

func makeKeyGenDataFilePath(dir string, partyIndex int) string {
	return fmt.Sprintf("%s/keygen_data_%d.json", dir, partyIndex)
}

// ----- //

const (
	// taken from line 1 of `test_data/preParam_test.data` in this repo
	preParamDataHex = "7b225061696c6c696572534b223a7b224e223a32323638383434363936303134393031333737313536363536363236393736343131333633363035333336343138303130303530343934323437333639373437353034373834323434303737323736363833313630373133353034313536393434383735353531343536373530353438313231343838373031373031353437303330313534343533323533373732343439373336313635383331323533393238323730313832323337383832363536333231363439353737333238383734373638353636373639393532323932353533313535383833303639383536343839303737303634313232393333333939323839343034373134363639373036333930363836363931383935343234363439373038363537323238363833353231363436373730353433333139383739373033363735323635353436363234343932393630303936333835303636303232303538363031303234373231383339303837383735353835333838383033353438323937373035303538363834303037393635363134343333373134393735333039323734303232333039373334343730353434353335313538303031383430383338333539333331383034383932343537333533363534383234373033313632363436353239323738363134363235363531303936303933353834363334313637383737383238373631323733313831323739303936353030383333373437303836363136333238393735313832353137333835373433383239373238363739363330343038393938323934383130373137353639383038323537333234353737343930393131363439343633383530363435303531323835332c224c616d6264614e223a31313334343232333438303037343530363838353738333238333133343838323035363831383032363638323039303035303235323437313233363834383733373532333932313232303338363338333431353830333536373532303738343732343337373735373238333735323734303630373434333530383530373733353135303737323236363236383836323234383638303832393135363236393634313335303931313138393431333238313630383234373838363634343337333834323833333834393736313436323736353737393431353334393238323434353338353332303631343636363939363434373032333537333334383533313935333433333435393437373132333234383534333238363134333431373630383233333835323731363539393339383531383337363137363935363334313931313535393934363931373439323635363230353733353136333837313337383830323838303932363235393334393331313131343432323736353438303334313232363338383932323338303432363137353039303033363536363833333632313932343739363635393439383934343834373434353039313630343133383830393734393035323538363431393933313235363936323537363037323137303131313030393135343034373533343534363838323332393831333632303930383834323933383631383333383932373830373338323732383531313833373533383538383233353131383938323030343439383230333431363932393734333731323036353733313538333737303734393731303031363239383638303237373432353636353031342c225068694e223a32323638383434363936303134393031333737313536363536363236393736343131333633363035333336343138303130303530343934323437333639373437353034373834323434303737323736363833313630373133353034313536393434383735353531343536373530353438313231343838373031373031353437303330313534343533323533373732343439373336313635383331323533393238323730313832323337383832363536333231363439353737333238383734373638353636373639393532323932353533313535383833303639383536343839303737303634313232393333333939323839343034373134363639373036333930363836363931383935343234363439373038363537323238363833353231363436373730353433333139383739373033363735323335333931323638333832333131393839333833343938353331323431313437303332373734323735373630353736313835323531383639383632323232383834353533303936303638323435323737373834343736303835323335303138303037333133333636373234333834393539333331383939373838393639343839303138333230383237373631393439383130353137323833393836323531333932353135323134343334303232323031383330383039353036393039333736343635393632373234313831373638353837373233363637373835353631343736353435373032333637353037373137363437303233373936343030383939363430363833333835393438373432343133313436333136373534313439393432303033323539373336303535343835313333303032387d2c22417574684563647361507269766174654b6579223a7b225075626c69634b6579223a7b2258223a32323433343236323035333831363930343233313330323131333436333132363839393031343934363639343636343630373637363937343235353535323130373333303237323931383531342c2259223a393838313638313436383433303831303338363336373137313032383935383833363631323637383137393538333738373236363930353236353732303930353239363736383735313438357d2c2244223a38363231393232373334393435353033303430323430353835373839353632343833373533393837393332303730373432343531323536373530363136353035363332373639363233373632327d2c224e54696c646569223a32313834313536333936303231393435393532373836343435333339393631373037313130323238333139313135373337393239383531303333323938373032333532353533343234393232343539313638363633383134303738353230313138363334323332333532373034343537303635393535313631343931343237313130373637393333383737363439333236303938383637333934383831313137353238343932333634373533353130333731303733333633313436333434383531373334383639303331313934393832373533333337313031333239353439353831333034383834373033323438313235383937393336353831353035323334323233333331343135393537363633343135353630373835373934303735373635363138353630343533373739383030383236303339313933303335303433343130343638363931383935363837313137303933373537313836383536383432353132383439333333383732333635303839323838323634353833353933373536313031333831353834303334353635313633323937393432383333333931353439373838373531353837353638363039313032373337313432373335363537383435333438323335383739363733303933333532393039313735393333353231363637333238323932363331333130333032303037373932343233373434383039333037363838353538303432323635323435323738303937363935393334303436343039393336303133383236363030313831363432383235303931373439373732323832373834343839393136313035383537303932353737323334313430373230383238312c22483169223a31363037303633363933333932343031383937363431323735383232323833303939353535383339353633383532363334313332393435363434343834353238373031333033383935313539323430303635313737383235303332353531323131393939323635323637373632313436343138353739383830343936373331373239363333323336343236353130343239373236373931353034303138373431313231333332313138363338333339353030393035303638303836343436313031343239363036313133373932323332323031373634313537303532313235323032373938363337303437393632343637353139333433373237323635303936353937333936373331363831333736323136363435303434383136313338393435303536383233363930313531363938393734323938313030373339313636343939383730313733353632343937333530333730353536383738333330303436373437303539343434393335333231353738343737353034373034353533333030303132393235363134313833333536333439363737333539363437313639313730363832333134313039383833363439353537363133393634333037393630303837323737313632333237343837333330333434313631393432373032383034383232303036333736303237303232393334363935303535373534353835363432363838373835373436363037323438343630363236343634383033363134373933373136313532363034363034383535313131333332353633343133353635373433383233363330363338333438353738363333383636383539383731383033333036303538322c22483269223a31363333323837303231383736313139333536373133393031373936353536343535393236333631313031353339313637323031393037313032343133363230393537333632363233343332313834393834363835383337343231373434363530303732393737313638323939303639313939373337333034393334363639363437373737393934383835303737393631323632363433383931323938393234373030393233343036323936323436323135363831363336373837353334363131373439363938383731393638393430313634323037383439373836373439393930383231343839363930343535363332393636393332303833333634373537333636363330333739343730313235363235343731353434313731383332363639393635343036393836363834303039393533393536313339363933343333303031393633323736323136373731373637353534353636363631323531303539333735373630393835353236393430373734363732313437363037353339313832383832303034313630333534353133383730313334383936383732363736383531313032363431333430343932363839383335323931373337313431363432333336373135313532393833313237313034363333353337393335353934323334333831323736363435323839323936373939373935373439363437303831373132383538383934313034303435303736393539333335393335303632353038323537383135333832353232313430313231323539353336333138393337323336333834393439333135343933393736343132343434353234313933373635333935343232373237362c22416c706861223a363134353937373135363331393133303137343732313435333039313730353231313535383934333136353532333137333138303330323338343134323333363039343339363832363939313039373734333736363037333038313938333430313133363237333234333130313630373638323933343637363833353437333531323539313532343538333939353639363130353734363434363539373232393738383437383632313332393535383830303835353838323335313530333438353130393333363235313935313536373837383438323239303938373036373735343631323334393536333839353533343939363932353030373237343130323030363132323436393534393937393331353938343531383032313936303536363138333032353735373531313330373831333632333533353337383839373130333235363532333438383533343938333639313337393737333737353231353631373432373337373137323039343639313532343833363434303636313436353838323339303233393432373732363636313432343338313030363637353339333934323937323537333637393536333231383139333434383035323939353735383330313438363830383936323235393938363137323630343537383139333533383135333935353831343737343931313236333631333538353835313431373434343537393135303033393932373437343034303934373530323439363038303033393238363734373335373738353132353331393231353334373231383832303038323534323332323337363430343739383036383031373936353034353536333638372c2242657461223a313136373432393838373039373532353034303135313335353333353634323230343231353331393438373633343037313735353237333037393235313734363031333336363233383739343736303432333133303536383632363436343530323732373437313339383335363532313335343133313633353538343233343839323238393431363330393934383533383531383134333732333836363736313233323430333130343938303833343830353434333931303333393038333237333531323232353835383134383332343631373733373335323338363831343030313431363735393437303238363738313732383033313337363838373236323233353031373738303432323639303733343030383939323035353331383238353639323437313838363833343831323036373232323530303132343835313034373732383836313834363132363335383036303835313531383533353638333933323838343330353338373533383633363434333438343734313635333631373235313832383237333839343635363439393635383630373434373838303431323030333333383531393233343536313431303538323136353339383039333732303535363531383936303334313535383339363935323030363031323435313033313939383237353531393833303031343937373138363233393335383530313239383834373133373231393131393639383632313933343430393631343631343535313233323836393239303933333138363736393032373334363431333631323332303937333837313138383835323238313130363233383535373736343638333837372c2250223a36383733313434343935343633323836373233303732353737383633373435333432333931333839353635373932313833313430313539393038303531353835353630373037343632313739313935313133373837333137353835393632343236303937303234323733373037373238383138363035313430343731353538333434313738383036383130303135393933363330373238333935373636383131313235393635353834333734333330343331303036323936323233343437363836333736383635393734343736393737303432353433303838313432393037363836303032383434303833343334303636393035373533363431383734363839373931383333353337363536363339313336353130313237373438353538313836303636313937393938313435323234383237312c2251223a37393434353331303536353736383939383935333832303632323138313536313136333336393535373333363236313131363637323932353532343137333630303430313234353338373935373138343833373032333339303833353333313036383238383737373636383935353135383431383336323039343331323434383236383637313430313132343131353231383832323933313532323839393439393432383332343236323031313832323533343236323233383535373234343336373938343931303530313538343832373332383136313232353631343830353737313536353931333037363335373931383834363737383538323031323831323133313631393235383731383137363535373036343635343934343837303233333337373434373733373738313331393638337d"
)
